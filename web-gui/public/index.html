<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CKAN Open Data Explorer</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        --primary: #06b6d4;
        --primary-dark: #0891b2;
        --bg-main: #0f1419;
        --bg-secondary: #1a1f28;
        --bg-tertiary: #252d38;
        --text-primary: #f8fafc;
        --text-secondary: #cbd5e1;
        --text-muted: #64748b;
        --border: #334155;
        --accent-gradient: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'IBM Plex Sans', sans-serif;
        background: var(--bg-main);
        color: var(--text-primary);
        overflow-x: hidden;
      }

      /* Background grid pattern */
      body::before {
        content: '';
        position: fixed;
        inset: 0;
        background-image:
          linear-gradient(to right, rgba(255,255,255,0.02) 1px, transparent 1px),
          linear-gradient(to bottom, rgba(255,255,255,0.02) 1px, transparent 1px);
        background-size: 32px 32px;
        pointer-events: none;
        z-index: 0;
      }

      .serif {
        font-family: 'DM Serif Display', serif;
      }

      /* Smooth animations */
      @keyframes slideInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes pulse {
        0%, 100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      @keyframes shimmer {
        0% {
          background-position: -1000px 0;
        }
        100% {
          background-position: 1000px 0;
        }
      }

      .animate-slide-in {
        animation: slideInUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .animate-pulse-slow {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: var(--bg-secondary);
      }

      ::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted);
      }

      /* Glass morphism effect */
      .glass {
        background: rgba(26, 31, 40, 0.6);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      /* Gradient text */
      .gradient-text {
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* Message animations */
      .message-user {
        animation: slideInUp 0.3s ease-out;
        margin-left: auto;
        max-width: 80%;
      }

      .message-assistant {
        animation: slideInUp 0.3s ease-out 0.1s both;
        max-width: 100%;
      }

      /* Dataset card hover effect */
      .dataset-card {
        transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        border: 1px solid var(--border);
      }

      .dataset-card:hover {
        transform: translateY(-2px);
        border-color: var(--primary);
        box-shadow: 0 8px 24px rgba(6, 182, 212, 0.15);
      }

      /* Button styles */
      .btn-primary {
        background: var(--accent-gradient);
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }

      .btn-primary::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .btn-primary:hover::before {
        opacity: 1;
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 16px rgba(6, 182, 212, 0.3);
      }

      .btn-secondary {
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        transition: all 0.2s ease;
      }

      .btn-secondary:hover {
        background: var(--bg-secondary);
        border-color: var(--text-muted);
      }

      /* Input focus states */
      input:focus, textarea:focus {
        outline: none;
        border-color: var(--primary) !important;
        box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
      }

      /* Status indicator pulse */
      .status-online {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        box-shadow: 0 0 0 0 rgba(6, 182, 212, 0.4);
      }

      /* Collapsible settings */
      .settings-collapsed {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .settings-expanded {
        max-height: 1000px;
        transition: max-height 0.5s cubic-bezier(0.16, 1, 0.3, 1);
      }

      /* Loading shimmer */
      .shimmer {
        background: linear-gradient(
          90deg,
          var(--bg-tertiary) 0%,
          rgba(255,255,255,0.05) 50%,
          var(--bg-tertiary) 100%
        );
        background-size: 1000px 100%;
        animation: shimmer 2s infinite linear;
      }
    </style>
  </head>
  <body class="min-h-screen">
    <main class="relative z-10 mx-auto flex w-full max-w-5xl flex-col gap-6 px-4 py-8 md:py-12">
      <!-- Header -->
      <header class="glass rounded-2xl p-6 md:p-8 animate-slide-in">
        <div class="flex items-start justify-between gap-4 mb-6">
          <div class="flex-1">
            <h1 class="serif text-4xl md:text-5xl mb-2 gradient-text">
              CKAN Explorer
            </h1>
            <p class="text-base" style="color: var(--text-secondary);">
              Conversational interface for open data research
            </p>
          </div>
          <div class="flex items-center gap-2 px-3 py-2 rounded-full" style="background: var(--bg-tertiary); border: 1px solid var(--border);">
            <span id="status-dot" class="h-2.5 w-2.5 rounded-full" style="background: var(--text-muted);"></span>
            <span id="status-text" class="text-sm" style="color: var(--text-secondary);">Checking...</span>
          </div>
        </div>

        <!-- Settings toggle -->
        <button
          id="settings-toggle"
          class="w-full flex items-center justify-between px-4 py-3 rounded-xl mb-4 btn-secondary text-sm font-medium"
          style="color: var(--text-secondary);"
        >
          <span>‚öôÔ∏è Configuration</span>
          <svg id="settings-icon" class="w-5 h-5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>

        <!-- Settings panel -->
        <div id="settings-panel" class="settings-collapsed">
          <div class="grid gap-4 md:grid-cols-3 mb-4">
            <label class="flex flex-col gap-2">
              <span class="text-xs font-medium uppercase tracking-wider" style="color: var(--text-muted);">MCP Endpoint</span>
              <input
                id="mcp-endpoint"
                class="rounded-lg px-3 py-2.5 text-sm transition-all"
                style="background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary);"
                placeholder="https://ckan-mcp-server.andy-pr.workers.dev/mcp"
              />
            </label>
            <label class="flex flex-col gap-2">
              <span class="text-xs font-medium uppercase tracking-wider" style="color: var(--text-muted);">CKAN Server</span>
              <input
                id="ckan-server"
                class="rounded-lg px-3 py-2.5 text-sm transition-all"
                style="background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary);"
                placeholder="https://www.dati.gov.it/opendata"
              />
            </label>
            <label class="flex flex-col gap-2">
              <span class="text-xs font-medium uppercase tracking-wider" style="color: var(--text-muted);">Gemini API Key</span>
              <input
                id="gemini-key"
                type="password"
                class="rounded-lg px-3 py-2.5 text-sm transition-all"
                style="background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary);"
                placeholder="AIza..."
              />
            </label>
          </div>
          <div class="flex flex-wrap items-center justify-between gap-4">
            <button
              id="save-settings"
              class="btn-primary px-6 py-2.5 rounded-lg font-medium text-sm text-white"
            >
              Apply Settings
            </button>
            <p class="text-xs" style="color: var(--text-muted);">
              Powered by Gemini 2.5 Flash ‚Ä¢ Natural language queries
            </p>
          </div>
        </div>
      </header>

      <!-- Messages area -->
      <section class="glass rounded-2xl p-6 min-h-[400px] flex flex-col animate-slide-in" style="animation-delay: 0.1s;">
        <div id="tool-status" class="hidden mb-4 px-4 py-2 rounded-lg shimmer text-sm font-medium" style="color: var(--primary);">
          ‚ö° Processing...
        </div>
        <div id="messages" class="flex flex-col gap-4 flex-1">
          <div class="message-assistant rounded-xl px-4 py-3 text-sm" style="background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border);">
            üëã Welcome! Ask me anything about open datasets (e.g., "renewable energy datasets")
          </div>
        </div>
      </section>

      <!-- Input area -->
      <section class="glass rounded-2xl p-4 md:p-6 animate-slide-in" style="animation-delay: 0.2s;">
        <div class="flex flex-col md:flex-row gap-3">
          <textarea
            id="message-input"
            rows="2"
            class="flex-1 rounded-xl px-4 py-3 text-sm resize-none transition-all"
            style="background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary);"
            placeholder="Ask about datasets..."
          ></textarea>
          <div class="flex gap-2">
            <button
              id="reset-btn"
              class="btn-secondary px-5 py-3 rounded-xl text-sm font-medium whitespace-nowrap"
              style="color: var(--text-secondary);"
              title="Clear conversation"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
            </button>
            <button
              id="send-btn"
              class="btn-primary px-6 py-3 rounded-xl text-sm font-semibold text-white whitespace-nowrap flex items-center gap-2"
            >
              <span>Search</span>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
              </svg>
            </button>
          </div>
        </div>
      </section>
    </main>

    <script>
      const DEFAULT_ENDPOINT = "https://ckan-mcp-server.andy-pr.workers.dev/mcp";
      const DEFAULT_CKAN = "https://www.dati.gov.it/opendata";
      const CORS_PROXY = "https://corsproxy.io/?";

      const elements = {
        endpoint: document.getElementById("mcp-endpoint"),
        ckan: document.getElementById("ckan-server"),
        geminiKey: document.getElementById("gemini-key"),
        save: document.getElementById("save-settings"),
        statusDot: document.getElementById("status-dot"),
        statusText: document.getElementById("status-text"),
        messages: document.getElementById("messages"),
        input: document.getElementById("message-input"),
        send: document.getElementById("send-btn"),
        reset: document.getElementById("reset-btn"),
        toolStatus: document.getElementById("tool-status"),
        settingsToggle: document.getElementById("settings-toggle"),
        settingsPanel: document.getElementById("settings-panel"),
        settingsIcon: document.getElementById("settings-icon")
      };

      const state = {
        endpoint: localStorage.getItem("mcpEndpoint") || DEFAULT_ENDPOINT,
        ckanServer: localStorage.getItem("ckanServer") || DEFAULT_CKAN,
        geminiKey: localStorage.getItem("geminiApiKey") || "",
        busy: false,
        conversationHistory: [],
        settingsExpanded: false,
        availableTools: []
      };

      elements.endpoint.value = state.endpoint;
      elements.ckan.value = state.ckanServer;
      elements.geminiKey.value = state.geminiKey;

      const setStatus = (status, text) => {
        elements.statusText.textContent = text;
        elements.statusDot.className = "h-2.5 w-2.5 rounded-full";
        if (status === "ok") {
          elements.statusDot.style.background = "#06b6d4";
          elements.statusDot.classList.add("status-online");
        } else if (status === "error") {
          elements.statusDot.style.background = "#ef4444";
          elements.statusDot.classList.remove("status-online");
        } else {
          elements.statusDot.style.background = "#64748b";
          elements.statusDot.classList.remove("status-online");
        }
      };

      const setToolStatus = (message) => {
        if (message) {
          elements.toolStatus.textContent = message;
          elements.toolStatus.classList.remove("hidden");
        } else {
          elements.toolStatus.classList.add("hidden");
        }
      };

      const addMessage = (role, content) => {
        const wrapper = document.createElement("div");

        if (role === "user") {
          wrapper.className = "message-user rounded-xl px-4 py-3 text-sm";
          wrapper.style.cssText = "background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%); color: white; font-weight: 500;";
        } else {
          wrapper.className = "message-assistant rounded-xl px-4 py-3 text-sm";
          wrapper.style.cssText = "background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border);";
        }

        if (typeof content === "string") {
          wrapper.textContent = content;
        } else {
          wrapper.appendChild(content);
        }

        elements.messages.appendChild(wrapper);
        setTimeout(() => {
          wrapper.scrollIntoView({ behavior: "smooth", block: "end" });
        }, 100);
      };

      const createDatasetCard = (dataset) => {
        const card = document.createElement("div");
        card.className = "dataset-card rounded-xl p-5 cursor-pointer";
        card.style.cssText = "background: var(--bg-secondary);";

        const title = document.createElement("h3");
        title.className = "text-base font-semibold mb-2";
        title.style.color = "var(--text-primary)";
        title.textContent = dataset.title || dataset.name || "Dataset";

        const desc = document.createElement("p");
        desc.className = "text-sm mb-3 line-clamp-2";
        desc.style.color = "var(--text-secondary)";
        desc.textContent = dataset.notes || "No description available.";

        const meta = document.createElement("div");
        meta.className = "flex items-center gap-4 text-xs";
        meta.style.color = "var(--text-muted)";

        const orgName = dataset.organization?.title || dataset.organization?.name || "Unknown";
        const resources = Array.isArray(dataset.resources) ? dataset.resources.length : 0;

        meta.innerHTML = `
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
            </svg>
            ${orgName}
          </span>
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
            </svg>
            ${resources} resource${resources !== 1 ? 's' : ''}
          </span>
        `;

        card.append(title, desc, meta);
        return card;
      };

      const createOrganizationCard = (org) => {
        const card = document.createElement("div");
        card.className = "dataset-card rounded-xl p-5 cursor-pointer";
        card.style.cssText = "background: var(--bg-secondary);";

        const title = document.createElement("h3");
        title.className = "text-base font-semibold mb-2";
        title.style.color = "var(--text-primary)";
        title.textContent = org.title || org.display_name || org.name || "Organization";

        const desc = document.createElement("p");
        desc.className = "text-sm mb-3 line-clamp-2";
        desc.style.color = "var(--text-secondary)";
        desc.textContent = org.description || "No description available.";

        const meta = document.createElement("div");
        meta.className = "flex items-center gap-4 text-xs";
        meta.style.color = "var(--text-muted)";

        const packageCount = org.package_count || org.packages?.length || 0;

        meta.innerHTML = `
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
            </svg>
            ${packageCount.toLocaleString()} dataset${packageCount !== 1 ? 's' : ''}
          </span>
        `;

        card.append(title, desc, meta);
        return card;
      };

      const extractStructured = (result) => {
        if (!result) return null;
        if (result.structuredContent) return result.structuredContent;
        const text = result.content?.[0]?.text;
        if (!text) return null;
        try {
          return JSON.parse(text);
        } catch {
          return null;
        }
      };

      const requestMcp = async (method, params, useProxy = false) => {
        const endpoint = useProxy ? `${CORS_PROXY}${encodeURIComponent(state.endpoint)}` : state.endpoint;
        const payload = {
          jsonrpc: "2.0",
          id: crypto.randomUUID(),
          method,
          params
        };
        const response = await fetch(endpoint, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json, text/event-stream"
          },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        if (data.error) {
          throw new Error(data.error.message || "MCP Error");
        }
        return data.result;
      };

      const callMcp = async (method, params) => {
        try {
          return await requestMcp(method, params, false);
        } catch (error) {
          return await requestMcp(method, params, true);
        }
      };

      const checkMcp = async () => {
        setStatus("checking", "Checking...");
        try {
          const result = await callMcp("tools/list", {});
          state.availableTools = result.tools || [];
          console.log("Available MCP tools:", state.availableTools.map(t => t.name));
          setStatus("ok", `Online (${state.availableTools.length} tools)`);
        } catch (error) {
          console.error("MCP check error:", error);
          setStatus("error", "Offline");
          state.availableTools = [];
        }
      };

      const stopwords = new Set([
        "a", "al", "allo", "alla", "alle", "ai", "agli", "da", "dal", "dallo",
        "dalla", "delle", "dei", "del", "della", "di", "e", "ed", "il", "lo",
        "la", "le", "i", "gli", "in", "su", "per", "con", "che", "quali",
        "quale", "quanti", "quanto", "tema", "dataset"
      ]);

      const normalizeQuery = (query) => {
        if (/["*:]|\bAND\b|\bOR\b|\bNOT\b/i.test(query)) {
          return query;
        }
        const tokens = query
          .toLowerCase()
          .match(/[\p{L}\p{N}]+/gu)
          ?.filter((token) => token.length > 1 && !stopwords.has(token));
        if (!tokens || tokens.length === 0) return "*:*";
        return tokens.join(" ");
      };

      const callGemini = async (userQuery, history = []) => {
        if (!state.geminiKey) {
          throw new Error("Missing Gemini API key");
        }

        // Build tool list for prompt
        const toolList = state.availableTools.map(t =>
          `- ${t.name}: ${t.description?.substring(0, 100) || 'No description'}`
        ).join('\n');

        const systemPrompt = `You are an assistant for CKAN open data queries.
Available MCP tools:
${toolList}

Choose the most appropriate tool and generate its arguments.
Respond ONLY with JSON in this format:
{
  "tool": "tool_name",
  "arguments": {
    "server_url": "CKAN_SERVER",
    ...other params based on tool schema
  }
}

For dataset searches use ckan_package_search or ckan_find_relevant_datasets.
For organization queries use ckan_organization_list, ckan_organization_show, or ckan_organization_search.
For tags use ckan_tag_list.
Always include server_url parameter.
Use conversation context to refine queries.`;

        const contents = [
          ...history,
          {
            role: "user",
            parts: [{ text: `${systemPrompt}\n\nCKAN Server: ${state.ckanServer}\nUser request: ${userQuery}` }]
          }
        ];

        const response = await fetch(
          `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${state.geminiKey}`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json"
            },
            body: JSON.stringify({
              contents: contents,
              generationConfig: { temperature: 0.2, maxOutputTokens: 500 }
            })
          }
        );

        if (!response.ok) {
          throw new Error(`Gemini HTTP ${response.status}`);
        }

        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
        console.log("Gemini raw response:", text);
        const jsonStart = text.indexOf("{");
        const jsonEnd = text.lastIndexOf("}");
        if (jsonStart === -1 || jsonEnd === -1) {
          console.error("No JSON found in Gemini response");
          throw new Error("Invalid Gemini response");
        }

        const jsonText = text.slice(jsonStart, jsonEnd + 1);
        console.log("Extracted JSON:", jsonText);
        const parsed = JSON.parse(jsonText);
        console.log("Parsed Gemini response:", parsed);

        if (!parsed.tool || !parsed.arguments) {
          console.error("Missing tool or arguments in response");
          throw new Error("Gemini did not return tool and arguments");
        }

        return parsed;
      };

      const runSearch = async (query) => {
        // Try Gemini to select tool and arguments
        let toolCall;
        try {
          toolCall = await callGemini(query, state.conversationHistory);
          console.log("Gemini selected tool:", toolCall);
        } catch (error) {
          console.error("Gemini error:", error);
          // Fallback: use ckan_package_search with normalized query
          const normalizedQuery = normalizeQuery(query);
          toolCall = {
            tool: "ckan_package_search",
            arguments: {
              server_url: state.ckanServer,
              q: normalizedQuery,
              rows: 5,
              response_format: "json"
            }
          };
          console.log("Using fallback tool:", toolCall);
        }

        // Ensure server_url is set
        if (!toolCall.arguments.server_url) {
          toolCall.arguments.server_url = state.ckanServer;
        }

        // Ensure response_format is json for programmatic parsing
        if (!toolCall.arguments.response_format) {
          toolCall.arguments.response_format = "json";
        }

        console.log("Final tool call:", toolCall);
        setToolStatus(`‚ö° Using ${toolCall.tool}...`);
        const result = await callMcp("tools/call", {
          name: toolCall.tool,
          arguments: toolCall.arguments
        });
        console.log("MCP result:", result);
        setToolStatus("");

        const data = extractStructured(result);
        console.log("Extracted data:", data);
        return {
          tool: toolCall.tool,
          data: data
        };
      };

      const handleSend = async () => {
        const query = elements.input.value.trim();
        if (!query || state.busy) return;
        state.busy = true;
        elements.send.disabled = true;
        elements.send.style.opacity = "0.5";

        addMessage("user", query);
        elements.input.value = "";

        // Add user message to conversation history
        state.conversationHistory.push({
          role: "user",
          parts: [{ text: query }]
        });

        try {
          const response = await runSearch(query);
          const { tool, data } = response;

          if (!data) {
            addMessage("assistant", "No results found.");
            state.conversationHistory.push({
              role: "model",
              parts: [{ text: "No results found." }]
            });
            return;
          }

          const container = document.createElement("div");
          container.className = "flex flex-col gap-3";

          // Handle different tool types
          if (tool.includes("organization")) {
            // Organization tools
            const items = data.results || data || [];
            const summary = document.createElement("p");
            summary.className = "text-sm font-medium mb-1";
            summary.style.color = "var(--primary)";
            summary.textContent = `üè¢ Found ${data.count ?? items.length} organization${(data.count ?? items.length) !== 1 ? 's' : ''}`;
            container.appendChild(summary);

            items.slice(0, 10).forEach((org) => container.appendChild(createOrganizationCard(org)));
            addMessage("assistant", container);

            state.conversationHistory.push({
              role: "model",
              parts: [{ text: `Found ${data.count ?? items.length} organizations for "${query}"` }]
            });
          } else {
            // Dataset tools (package_search, find_relevant_datasets, etc.)
            const items = data.results || data || [];
            const summary = document.createElement("p");
            summary.className = "text-sm font-medium mb-1";
            summary.style.color = "var(--primary)";
            summary.textContent = `üìä Found ${data.count ?? items.length} dataset${(data.count ?? items.length) !== 1 ? 's' : ''}`;
            container.appendChild(summary);

            items.slice(0, 10).forEach((dataset) => container.appendChild(createDatasetCard(dataset)));
            addMessage("assistant", container);

            state.conversationHistory.push({
              role: "model",
              parts: [{ text: `Found ${data.count ?? items.length} datasets for "${query}"` }]
            });
          }
        } catch (error) {
          addMessage("assistant", `‚ùå Error: ${error.message || "Could not contact MCP"}`);
          state.conversationHistory.push({
            role: "model",
            parts: [{ text: `Error: ${error.message || "Could not contact MCP"}` }]
          });
        } finally {
          state.busy = false;
          elements.send.disabled = false;
          elements.send.style.opacity = "1";
          setToolStatus("");

          // Limit history to last 10 messages (5 exchanges)
          if (state.conversationHistory.length > 10) {
            state.conversationHistory = state.conversationHistory.slice(-10);
          }
        }
      };

      // Settings toggle
      elements.settingsToggle.addEventListener("click", () => {
        state.settingsExpanded = !state.settingsExpanded;
        if (state.settingsExpanded) {
          elements.settingsPanel.classList.remove("settings-collapsed");
          elements.settingsPanel.classList.add("settings-expanded");
          elements.settingsIcon.style.transform = "rotate(180deg)";
        } else {
          elements.settingsPanel.classList.remove("settings-expanded");
          elements.settingsPanel.classList.add("settings-collapsed");
          elements.settingsIcon.style.transform = "rotate(0deg)";
        }
      });

      elements.save.addEventListener("click", async () => {
        state.endpoint = elements.endpoint.value.trim() || DEFAULT_ENDPOINT;
        state.ckanServer = elements.ckan.value.trim() || DEFAULT_CKAN;
        state.geminiKey = elements.geminiKey.value.trim();
        localStorage.setItem("mcpEndpoint", state.endpoint);
        localStorage.setItem("ckanServer", state.ckanServer);
        localStorage.setItem("geminiApiKey", state.geminiKey);
        await checkMcp();
      });

      elements.send.addEventListener("click", handleSend);
      elements.input.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          handleSend();
        }
      });

      elements.reset.addEventListener("click", () => {
        state.conversationHistory = [];
        elements.messages.innerHTML = '<div class="message-assistant rounded-xl px-4 py-3 text-sm" style="background: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border);">üîÑ Conversation reset. Ask me anything!</div>';
      });

      checkMcp();
    </script>
  </body>
</html>
